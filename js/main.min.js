function setupAudioNodes(){sourceNode=audioContext.createBufferSource(),analyserNode=audioContext.createAnalyser(),analyserNode.smoothingTimeConstant=0,analyserNode.fftSize=fftSize,javascriptNode=audioContext.createScriptProcessor(sampleSize,1,1),frequencyArray=new Uint8Array(analyserNode.frequencyBinCount),sourceNode.connect(audioContext.destination),sourceNode.connect(analyserNode),analyserNode.connect(javascriptNode),javascriptNode.connect(audioContext.destination)}function loadSound(e){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(e){audioData=e,playSound(audioData)},onError)},a.send()}function playSound(e){sourceNode.buffer=e,sourceNode.start(0),sourceNode.loop=!0,audioPlaying=!0}function onError(e){console.log(e)}function drawSpectrogram(){var e=document.createElement("canvas"),a=e.getContext("2d");e.width=canvasWidth,e.height=canvasHeight;for(var o=0;o<frequencyArray.length;o++)ctx.fillStyle=colorScale(frequencyArray[o]/512),ctx.fillRect(canvasWidth-1,canvasHeight-o,1,1);a.drawImage(canvas,0,0,canvasWidth,canvasHeight),ctx.translate(-1,0),ctx.drawImage(e,0,0,canvasWidth,canvasHeight,0,0,canvasWidth,canvasHeight),ctx.setTransform(1,0,0,1,0,0)}function clearCanvas(){ctx.clearRect(0,0,canvasWidth,canvasHeight)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e,a){window.setTimeout(e,1e3/60)}}(),window.AudioContext=function(){return window.webkitAudioContext||window.AudioContext||window.mozAudioContext}();var audioContext,audioBuffer,sourceNode,analyserNode,javascriptNode,audioData=null,audioPlaying=!1,sampleSize=2048,fftSize=1024,frequencyArray,audioUrl="sounds/comp.wav",canvasWidth=$("#canvas").width(),canvasHeight=$("#canvas").height(),ctx,colorScale=chroma.scale(["#ffffe0","#ffeec1","#ffdda7","#ffcb91","#ffb880","#ffa474","#fe8f6a","#f87d64","#f06a5e","#e65758","#db4551","#ce3447","#c0223b","#b0122c","#9e051b","#8b0000"]).out("hex");$(document).ready(function(){ctx=$("#canvas").get()[0].getContext("2d");try{audioContext=new AudioContext}catch(e){alert("Web Audio API is not supported in this browser")}setupAudioNodes(),javascriptNode.onaudioprocess=function(){analyserNode.getByteFrequencyData(frequencyArray),1==audioPlaying&&requestAnimFrame(drawSpectrogram)},null==audioData?loadSound(audioUrl):playSound(audioData)});